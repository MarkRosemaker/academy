<!-- Initialize output variables. -->
{{ $html_slice   := slice }}
{{ $popups := dict }}
{{ $word_classes_all := slice }}
{{ $learned_words := slice }}

<!-- We will be editing maps. -->
{{ $s := newScratch }}
{{ $s.Set "popups" $popups }}

<!-- Build all finished pages if set in config to true, if not server or if it's the sample unit. -->
{{ if and (not .Draft) (or .Site.Params.buildPopups (not .Site.IsServer) (eq .Title "Test-Einheit")) }}

    <!-- Get the data we have about words.  -->
    {{ $vocab := .Site.Data.a1_vocab }}
    {{ $basic_forms := .Site.Data.basic_forms }}
    {{ $custom_words := .Site.Data.custom_words }}

    <!-- Clean up the input. -->
    {{ $cat    := partial "category-notice.html" . }}
    {{ $input  := print $cat .Content | replaceRE "\n" ""  | replaceRE "\\s+" " " }}

    <!-- Make it into one word. -->
    {{ $input   = replace $input "Authentic German Learning" "Authentic_German_Learning" }}

    <!-- Keep track if it's the start of a sentence. -->
    {{ $sentence_start := true }}

    <!-- Seperate text from html brackets. -->
    {{ range split $input "<" }}
        {{ $tag  := . | replaceRE "(.*>).*" "$1" }}
        {{ $text := . | replaceRE ".*>" "" }}

        {{ with $tag }}
            {{ $html_slice = $html_slice | append "<" . }}
        {{ end }}

        {{ if findRE "\\Adiv|\\Ap|\\Alabel" $tag }}
            {{ $sentence_start = true }}
        {{ end }}

        {{ range split $text " " }}
            <!-- Seperate the word from surrounding characters. -->
            {{ $word := . | replaceRE "[^\\&;A-Za-zöäüßÖÄÜ_-]" "" }}
            {{ if not (in . $word)}}
                {{ errorf "Something went wrong analyzing '%s'. The extracted word is '%s'." . $word }}
            {{ end }}
            {{ $post := . | replaceRE (print ".*" $word ) "" }}

            {{ $pre  := . | replaceRE (print $word ".*") "" }}

            <!-- Don't analyze special characters. -->
            {{ if or (eq . "&ndash;") (eq . "&hellip;") }}
                {{ $word = "" }}
            {{ end }}

            {{ with $word }}
                {{ $html_slice = $html_slice | append $pre }}

                {{ $words := slice $word }}
                {{ if in $.Site.Data.splittable . }}
                    {{ $words = split $word "-" }}
                {{ end }}

                {{ $html_words := slice }}
                {{ range $words }}
                    {{ $word := . }}

                    <!-- In case it's 'Authentic_German_Learning'. -->
                    {{ $word = replace $word "_" " " }}

                    <!-- We might search for the lowercase version but still want to display the original word. -->
                    {{ $search := $word }}

                    <!-- Check capitalization. -->
                    {{ if $sentence_start }}
                        {{ $lower := lower $word }}

                        {{ if or (isset $basic_forms $lower) (isset $vocab $lower) (isset $custom_words $lower) }}
                            <!-- We know the lower variant is correct because we found it in our maps. -->
                            {{ $search = $lower }}
                        {{ else if not (or (isset $basic_forms $word) (isset $vocab $word) (isset $custom_words $word)) }}
                            <!-- We must know, set word into a json data map (even if value is empty). -->
                            {{ if and $.Site.Params.Debug.Capitalization (not $.Draft) }}
                                {{ errorf "Capitalization of \"%s\" unknown. Please add the word to 'data/basic_forms.json'." $word }}
                            {{ end }}
                        {{ end }}
                    {{ end }}

                    <!-- Get word info from our custom words or Wiktionary. -->
                    {{ $info := dict }}
                    {{ with index $custom_words $search }}
                        {{ $info = . }}
                    {{ else }}
                        {{ $info = partial "functions/get-word-info.html" (dict "Word" $search "Data" $.Site.Data) }}
                    {{ end }}

                    <!-- Check for basic forms. -->
                    {{ $basic_form := index $basic_forms $word | default $info.basic_form }}

                    <!-- Collect all the attributes and classes of the link element. -->
                    {{ $attr := dict "basic-form" $basic_form }}
                    {{ $s.Set "attr" $attr }}
                    {{ $html_classes := slice }}

                    {{ $id := $search | lower | urlize }}
                    {{ if len (findRE "\\A[A-ZÄÖÜ]" $search) }}
                        {{ $id = print $id "_cap" }}
                    {{ end }}

                    {{ with $info.html }}

                        <!-- Make the word into a popup element. -->
                        {{ $url := urlize $id | print "#word_" }}
                        {{ $s.SetInMap "attr" "href" $url }}
                        {{ $s.SetInMap "attr" "data-rel" "popup" }}
                        {{ $s.SetInMap "attr" "data-transition" "pop" }}
                        {{ with $info.translation }}
                            {{ $s.SetInMap "attr" "title" (print "\"" . "\"") }}
                        {{ end }}

                        {{ if not (isset $popups $id) }}
                            <!--
                                Add the html to the popup contents below the text.
                                Not used any more:
                                    data-dismissible=\"true\"
                                    data-position-to=\"window\"
                            -->
                            {{ $popup := print "<div class=ui-content data-role=popup id=word_" (urlize $id) " data-overlay-theme=a data-position-to=origin><a href=# data-rel=back class=\"ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right\">Schließen</a>" . "</div>" }}
                            {{ $s.SetInMap "popups" $id $popup }}
                        {{ end }}

                        <!-- Define classes of the text element. -->
                        {{ $html_classes = $html_classes | append "word-info" "ui-btn-inline" }}
                    {{ end }}

                    <!-- Add word types. -->
                    {{ range $info.word_classes }}
                        {{ $html_classes = $html_classes | append (replace . " " "-") }}
                        {{ $word_classes_all = $word_classes_all | append . }}
                    {{ end }}

                    <!-- Add audio file, if available. -->
                    {{ with $info.audio }}
                        {{ $s.SetInMap "attr" "audio" . }}
                        {{ $html_classes = $html_classes | append "audio-available" }}
                    {{ end }}

                    <!-- Check if it's an important word. -->
                    {{ with index $vocab $info.basic_form }}
                        {{ $html_classes = $html_classes | append "important" }}
                        {{ $learned_words = $learned_words | append $info.basic_form }}
                    {{ end }}

                    {{ $html_word := "" }}
                    {{ with $html_classes }}
                        {{ $html_word = "<a " }}
                        {{ range $a, $k := $attr }}
                            {{ $html_word = print $html_word $a "=" $k " " }}
                        {{ end }}
                        {{ $html_word = print $html_word "class=\"" (delimit $html_classes " ") "\">" $word "</a>" }}
                    {{ else }}
                        {{ if and $.Site.Params.Debug.MissingWords (not $.Draft) }}
                            {{ errorf "Could not find word \"%s\"." . }}
                        {{ end }}
                        {{ $html_word = print $html_word . "*" }}
                    {{ end }}
                    {{ $html_words = $html_words | append $html_word }}
                {{ end }}
                {{ $html_slice = $html_slice | append (delimit $html_words "-") $post " " }}

                {{ $sentence_start = or (in $post ".") (in $post "!") (in $post "?") }}
            {{ else }}
                {{ $html_slice = $html_slice | append . " " }}
            {{ end }}
        {{ end }}
    {{ end }}

{{ else }}
    {{ $html_slice = $html_slice | append .Content }}
{{ end }}<!-- end of  and .Site.Params.buildPopups .Params.spellchecked -->

<!-- The last is needed because otherwise underline messes up. -->
{{ $html := delimit $html_slice "" | replaceRE "\\s+</" "</" }}

{{ $word_classes_all := uniq $word_classes_all }}

{{ return dict "Content" $html "popups" $popups "word_classes" $word_classes_all "learned_words" $learned_words "Lang" $.Lang }}