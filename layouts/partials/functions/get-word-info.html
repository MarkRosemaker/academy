<!-- The word we are looking for. -->
{{ $word := . }}

<!-- Initialize output variable. -->
{{ $html  := "" }}
{{ $audio := "" }}
{{ $word_classes := slice }}
{{ $basic_form := "" }}

<!-- Get HTML from Wiktionary. -->
{{ $html_raw := "" }}
{{ $json := getJSON (print "https://de.wiktionary.org/w/api.php?action=parse&format=json&prop=text&disabletoc=true&page=" $word) }}
{{ with $json.parse.text }}{{ with index . "*" }}
    {{ with findRE "<a href=\"//upload.wikimedia.org/wikipedia/commons/.*?\" class=\"internal\" title=\".*?\">" . }}
        {{ $audio = print "https:" (index . 0) | replaceRE "<a .*href=\"|\".*" "" }}
    {{ end }}

    {{ $html_raw = . }}
{{ end }}{{ end }} <!-- end of HTML -->

{{ with $html_raw }}
    {{ range split $html_raw "<h2" }}
        <!-- Go through the entries of all languages, only chose the German ones. -->
        {{ if in . (print "id=\"" $word "_(Deutsch)\"") }}

            <!-- Analyse the rest by splitting into subsections (first word classes, then items in the entry). -->
            {{ $html_rest := . | replaceRE ".*</h2>" "" | replaceRE "\n" "" }}
            {{ range $num_wc, $k := split $html_rest "<h3" }}
                {{ if ne $num_wc 0 }}<!-- Discard first (just a template or nothing). -->
                    {{ $wc_names := slice }}<!-- names of all word classes in this iteration -->
                    {{ $wc_names_infos := slice }}<!-- name and info (like intransitive etc.) of all word classes  -->
                    {{ $wc_names_infos_i18n := slice }}

                    <!-- Check which word class are named in the header -->
                    {{ $wc_original := . | replaceRE "</h3>.*|\\A>|<span.*?>|</span>|<a.*?>|</a>|\\[.*|" "" }}
                    {{ $wc_current_name := "" }}
                    {{ $wc_current_infos := slice }}
                    {{ $wc_current_infos_i18n := slice }}
                    {{ $gender := "" }}
                    {{ $gender_map := dict "m" "männlich" "f" "weiblich" "n" "sächlich" "m/f/n" "männlich, weiblich, sächlich"}}
                    {{ range (split $wc_original ", " | append "" ) }}
                        {{ if in . "<" }}<!-- Is it info about the current word class or the name of a word class? -->
                            {{ $wc_current_info := . | replaceRE "<.*?>" ""  }}

                            {{ with index $gender_map $wc_current_info }}
                                {{ if not $gender }}
                                    {{ $gender = $wc_current_info }}
                                {{ end }}
                                {{ $wc_current_info = . }}
                            {{ end }}
                            {{ $wc_current_infos = $wc_current_infos | append $wc_current_info }}
                            {{ $wc_current_infos_i18n = $wc_current_infos_i18n | append (i18n $wc_current_info) }}
                        {{ else }}
                            <!-- It's a new word class. -->
                            {{ with $wc_current_name }}
                                {{ $wc_names = $wc_names | append $wc_current_name }}
                                {{ with $wc_current_infos }}
                                    {{ $wc_names_infos = $wc_names_infos | append (print $wc_current_name " (" (delimit . ", ") ")") }}
                                    {{ $wc_names_infos_i18n = $wc_names_infos_i18n | append (print (title (i18n $wc_current_name)) " (" (delimit $wc_current_infos_i18n ", ") ")") }}
                                    {{ $wc_current_infos = slice }}
                                    {{ $wc_current_infos_i18n = slice }}
                                {{ else }}
                                    {{ $wc_names_infos = $wc_names_infos | append $wc_current_name }}
                                    {{ $wc_names_infos_i18n = $wc_names_infos_i18n | append (title (i18n $wc_current_name)) }}
                                {{ end }}
                            {{ end }}
                            {{ $wc_current_name  = . | replaceRE "\\A " "" }} <!-- for some reason, the value was once " Toponym"-->
                        {{ end }}
                    {{ end }}
                    {{ $html_wc_name := print "<span lang=\"de\" class=\"de\">" (delimit $wc_names_infos ", ") "</span><br><span lang=\"en\" class=\"en trans\">" (delimit $wc_names_infos_i18n ", ") "</span>" }}

                    <!-- Add the word classes to a list to use as css classes. -->
                    {{ $word_classes = $word_classes | append $wc_names }}

                    <!-- Add the word classes to the list. -->
                    {{ if eq $num_wc 1 }}
                        <!-- Get the gender if it's the first entry. -->
                        {{ $article := "" }}
                        {{ $article_map := dict "m" "der " "f" "die " "n" "das " }}
                        {{ $gender_map := dict "m" "noun-m" "f" "noun-f" "n" "noun-n" "m/f/n" "noun-m" }}
                        {{ with $gender }}
                            {{ $article = index $article_map . }}
                            {{ $word_classes = $word_classes | append (index $gender_map .) }}
                        {{ end }}

                        {{ if in . "<li><a href=\"/wiki/Englisch\" title=\"Englisch\">Englisch</a>: "}}
                            <!-- Get the translation. -->
                            {{ $trans := . | replaceRE ".*<li><a href=\"/wiki/Englisch\" title=\"Englisch\">Englisch</a>: |</li>.*|<sup>.*?</sup>|<.*?>|&#160;|\\(.*?\\) " "" }}

                            {{ if eq (len (findRE "\\[" $trans)) 1}}
                                {{ $trans = $trans | replaceRE "\\[.*?\\] " "" }}
                            {{ end }}

                            <!-- Make breaks instead of semicolons. -->
                            {{ $trans = $trans | replaceRE "; " "<br>" }}

                            <!-- Add the word as a big header before the first entry. -->
                            {{ $html = print $html "<h2><span lang=\"de\" class=\"de\">" $article $word "</span><br><span lang=\"en\" class=\"en trans\">" $trans "</span></h2>" }}
                        {{ else }}
                            {{ $html = print $html "<h2>" $article $word "</h2>" }}
                        {{ end }}
                    {{ end }}

                    <!-- Now analyse everything under the header. -->
                    {{ $entry_rest := . | replaceRE ".*</h3>" "" }}
                    {{ $html_wc := "" }} <!-- This will be the html describing the word if it is this word class.

                    <!-- Transform the bold headers into real headers. -->
                    {{ $entry_rest = $entry_rest | replaceRE "<p><span style=\"visibility:hidden\".*?</span></p><div .*?>(.*?):</div>" "<h4>$1</h4>" }}
                    {{ $entry_rest = $entry_rest | replaceRE "<p style=\"margin-bottom: -0.5em;\"><b>(.*?):</b></p>" "<h4>$1</h4>" }}

                    <!-- Get images, if present. | class=\".*?\"| style=\".*?\"-->
                    {{ $pre := $entry_rest | replaceRE "<h4>.*" "" }}
                    {{ $html_image := "" }}
                    {{ $html_images := findRE "<div class=\"thumbinner\".*?</div></div>" $pre  }}
                    {{ range $html_images }}
                        <!-- Extract the image and caption. -->
                        {{ $img := . | replaceRE ".*(<img.*?/>).*" "$1$2" }}
                        {{ $caption := . | replaceRE ".*</div>(.*?)</div></div>" "$1" }}

                        <!-- Get an alt value for the image from the caption. -->
                        {{ $alt := $caption | replaceRE "<.*?>|\\[.*\\] " "" }}
                        {{ $img = $img | replaceRE ".*(<img.*?/>).*" "$1$2" | replaceRE "alt=\"\"" (print "alt=\"" $alt "\"") }}
                        {{ $width := $img | replaceRE ".* width=\"(.*?)\".*" "$1" }}

                        <!-- Construct html. -->
                        {{ $html_image = print $html_image "<div class=\"thumbinner\">" $img "<div class=\"thumbcaption\" style=\"width:" $width "px;\"><p>" $caption "</p></div></div>" }}
                    {{ end }}

                    <!-- Get the table, if present. -->
                    {{ $html_table := "" }}
                    {{ $html_tables := findRE "<table class=\"wikitable.*?\".*?</table>" $pre }}
                    {{ range $html_tables }}
                        {{ $html_table_raw := . | replaceRE "<a.*?>|</a>|<p class=\"mw-empty-elt\"></p>| class=\".*?\"| style=\".*?\"" "" | replaceRE "<table>" "<table class=\"wikitable\">" }}

                        <!-- Show link to Flexion:... -->
                        {{ $html_table_raw = $html_table_raw | replaceRE "(Flexion:.*?)([<.])" "<a href=\"https://de.wiktionary.org/wiki/$1\" target=\"_blank\">$1</a>$2" }}

                        <!-- Translate header cells. -->
                        {{ range findRE "<th.*?</th>" $html_table_raw }}
                            {{ $inner := . | replaceRE "<th.*?>|</th>" "" | replaceRE "&#160;" " " }}
                            {{ $pre   := . | replaceRE "(<th.*?>).*" "$1" }}

                            {{ if and $inner (ne $inner "—") (not (in $inner "Flexion:")) (not (in $inner "siehe auch:")) }}
                                {{ $inner_trans := "" }}
                                {{ if gt (len (findRE "\\ASingular" $inner)) 0 }}
                                <!-- for Singular 1, Singular 2, Singular <i>m</i> etc. -->
                                    {{ $inner_trans = "Singular" | i18n | title }}
                                    {{ $inner_trans = print $inner_trans (replaceRE "\\ASingular(.*)" "$1" $inner) }}
                                {{ else }}
                                    {{ $each_trans := slice }}
                                    {{ range split $inner ", " }}
                                        {{ $each_trans =  $each_trans | append (i18n .) }}
                                    {{ end }}
                                    {{ $inner_trans = delimit  $each_trans ", " | title }}
                                {{ end }}

                                {{ $inner_trans = print $pre "<span lang=\"de\" class=\"de\">" $inner "</span><br><span lang=\"en\" class=\"en trans\">" $inner_trans "</span></th>" }}
                                {{ $html_table_raw = $html_table_raw | replaceRE . $inner_trans }}
                            {{ end }}
                        {{ end }}

                        {{ if or (in $wc_names "Personalpronomen") (in $wc_names "Adjektiv") }}
                            <!-- Make the word bold in the table. -->
                            {{ $html_table_raw = $html_table_raw | replaceRE (print "<td>([^<]*)(" $word ")\\b") "<td>$1<strong>$2</strong>"}}
                        {{ end }}
                        {{ $html_table = print $html_table $html_table_raw }}
                    {{ end }}

                    {{ if or $html_image $html_table }}
                        {{ $html_wc = print $html_wc "<div class=\"non-text\">" $html_image $html_table "</div>" }}
                    {{ end }}

                    <!-- Split into seperate dictionary items. -->
                    {{ $entry_rest = $entry_rest | replaceRE "\\A.*?<h4" "<h4" }}
                    {{ range $k, $item := split $entry_rest "<h4" }}
                        {{ $header := . | replaceRE "\\A[^>]*?>|<\\/h4>.*|<[^>]*?>|\\[.*" "" | replaceRE "&#160;" " " }}
                        {{ $body   := . | replaceRE ".*<\\/h4>" "" }}

                        <!-- Make sure the header is blank for tables, pictures. -->
                        {{ if not (in . "</h4>") }}
                            {{  $header = "" }}
                        {{ end }}

                        <!-- Don't show hyphenation if there is none.-->
                        {{ if and (eq $header "Worttrennung") (not (in $body "·")) }}
                            {{ $body = "" }}
                        {{ end }}

                        <!-- Remove rhymes. -->
                        {{ $body = $body | replaceRE "<dd><a href=\"/wiki/Hilfe:Reime\".*?</dd>" "" }}

                        <!-- Remove style information. -->
                        {{ $body = $body | replaceRE "<table.*?>" "<table>"  | replaceRE "<th.*?>" "<th>" | replaceRE "<td.*?>" "<td>" | replaceRE "<p.*?>" "<p>" | replaceRE "<div([^>]*?)style=\".*?\"([^>]*?)>" "<div$1 $2>" | replaceRE " class=\".*?\"" "" | replaceRE "<div></div>" ""  }}

                        <!-- Make audio files playable (not just in pronunciation section). -->
                        {{ $body = $body | replaceRE "<span.*?>|</span.>" "" | replaceRE "(<img[^>]*?Loudspeaker.svg[^>]*?>&#160;)<a href=\"(.*?)\"[^>]*>(.*?)<\\/a>" "<span class=\"audio-available\" audio=\"https:$2\">$1$3</span>" }}

                        <!-- Correct false plurals. -->
                        {{ $lines := len (findRE "</dd>" $body) }}
                        {{ if lt $lines 2 }}
                            {{ if eq $header "Bedeutungen" }}
                                {{ $header = "Bedeutung"}}
                            {{ end }}
                            {{ if eq $header "Beispiele" }}
                                {{ $header = "Beispiel"}}
                            {{ end }}
                        {{ end }}

                        <!-- Clean up the html including all links. -->
                        {{ $body = $body | replaceRE "<p class=\"mw-empty-elt\"></p>|<a .*?>|</a>|\\(\\)|<!--.*?-->|<div[^<]*?title=\"Referenzen und weiterführende Informationen\".*|<sup.*?</sup>|<p><i><span style=\"visibility:hidden\" id=\"Quellen\">.*|<p>.*?Quellen:</i>.*|<a[^>]*?><\\/a>|<table><tbody><tr><th>Dialektausdrücke:</th></tr><tr><td><div id=\"Vorlage_Uberarbeiten\".*|<div id=\"Vorlage_Uberarbeiten\".*" "" }}

                        <!-- Clean up whitespaces. -->
                        {{ $body = $body | replaceRE "\\[([0-9]+), ([0-9]+)\\]" "[$1,&#160;$2]"  | replaceRE "#8206;" "&#160;" | replaceRE "(&#160;)+" "&#160;" | replaceRE "&#160; " "&#160;" | replaceRE "&#160;([;,.])" "$1" | replaceRE "\\s+" " " | replaceRE "<div[^>]*>&#160;</div>" "" }}

                        <!-- Correct image source links. -->
                        {{ $body = $body | replaceRE "src=\"(/w/extensions.*?)\"" "src=\"https://wiktionary.org$1\"" }}

                        <!-- Insert the entry for the basic form. -->
                        {{ if eq $header "Grammatische Merkmale" }}
                            {{ with findRE "flektierte Form von <b>(.*?).</b>" $body }}
                                {{ $basic_form_instance := index . 0 | replaceRE ".*<b>|\\.</b>" "" }}
                                {{ if eq $num_wc 1 }}
                                    {{ $basic_form = $basic_form_instance }}
                                {{ end }}

                                {{ $basic := partial "functions/get-word-info.html" $basic_form_instance }}

                                {{ $word_classes = $word_classes | append (index $basic.word_classes 0) }}

                                {{ $body = $body | replaceRE "</ul>.*" (print "</ul></div>" $basic.html) }}
                            {{ end }}
                        {{ end }}

                        {{ $html_item := "" }}
                        {{ with $body }}
                            {{ with $header }}

                                <!-- Translate the header. -->
                                {{ $header = print "<h4><span lang=\"de\" class=\"de\">" $header "</span><br><span lang=\"en\" class=\"en trans\">" (title (i18n $header)) "</span></h4>" }}

                                <!-- Small (or very important) entries are shown. -->
                                {{ $length := len (replaceRE "<[^>]*>" "" $body) }}
                                {{ if or (and (lt $length 100) (lt $lines 3)) (in $header "Grammatische Merkmale")}}
                                    {{ $html_item = print "<div class=\"ui-corner-all custom-corners\"><div class=\"ui-bar ui-bar-a\">" $header "</div><div class=\"ui-body ui-body-a\">" $body "</div></div>" }}
                                {{ else }}
                                    {{ $html_item = print "<div class=\"\" data-role=\"collapsible\">" $header $body "</div>" }}
                                {{ end }}

                                <!-- If there is audio in the body, play the first one when clicking on the header. -->
                                {{ if in $header "Aussprache" }}
                                    {{ with index (findRE "\"https://upload.*?\"" $body) 0 }}
                                        {{ $html_item = replaceRE "<h4>(.*?)</h4>" (print "<h4 audio=" . " class=\"audio-available\">$1</h4>") $html_item }}
                                    {{ end }}<!-- end with $header  -->
                                {{ end }}

                            {{ else }}
                                {{ $html_item = $body }}


                            {{ end }}<!-- end with $body  -->
                        {{ end }}<!-- end range over items -->
                        <!-- Add the item. -->
                        {{ $html_wc = print $html_wc $html_item }}
                    {{ end }}<!-- end range over items -->

                    <!-- Wrap in collapsible div. -->
                    {{ $html = print $html "<div data-role=\"collapsible\"" }}
                    {{ if eq $num_wc 1 }}
                        <!-- Expand the first. -->
                        {{ $html = print $html " data-collapsed=\"false\"" }}
                    {{ end }}
                    {{ $html = print $html "><h3>" $html_wc_name "</h3>" $html_wc "</div>" }}
                {{ end }}<!-- end if first -->
            {{ end }}<!-- end range over kinds -->

        {{ end }}
    {{ end }}
{{ end }}

{{ if not $basic_form }}
    {{ $basic_form = $word }}
{{ end }}

            <!-- TODO
                show to people and get feedback

                - consult docalyzer for counting
                same process for Wiktionary English, kind of merge with the other (e.g. look for matching word class and header, then put in orange in front)
                check for and fix errors, e.g.
                stop jumping to top when I click on something


                <table><tbody><tr><th>Dialektausdrücke:</th></tr><tr><td><div id="Vorlage_Uberarbeiten"><table><tbody><tr><td><img alt="Inv-Icon tools.png" src="//upload.wikimedia.org/wikipedia/commons/thumb/2/24/Inv-Icon_tools.png/24px-Inv-Icon_tools.png" decoding="async" width="24" height="24" srcset="//upload.wikimedia.org/wikipedia/commons/thumb/2/24/Inv-Icon_tools.png/36px-Inv-Icon_tools.png 1.5x, //upload.wikimedia.org/wikipedia/commons/thumb/2/24/Inv-Icon_tools.png/48px-Inv-Icon_tools.png 2x" data-file-width="150" data-file-height="150"></td><td>Dieser Eintrag oder Abschnitt bedarf einer Überarbeitung. Hilf bitte mit, ihn zu verbessern, und entferne anschließend diese Markierung.<div style="display: none;" id="word-10-placeholder"><!-- placeholder for word-10 --></div><div style="display: none;" id="word-11-placeholder"><!-- placeholder for word-11 --></div><div style="display: none;" id="word-12-placeholder"><!-- placeholder for word-12 --></div><div style="display: none;" id="word-13-placeholder"><!-- placeholder for word-13 --></div></td></tr></tbody></table></div></td></tr></tbody></table>
            -->

            {{ return dict "html" $html "audio" $audio "word_classes" $word_classes "basic_form" $basic_form }}